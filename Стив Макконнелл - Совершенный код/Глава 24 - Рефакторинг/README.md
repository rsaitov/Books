## Глава 24 - Рефакторинг
Осознав, что эволюция ПО во время разработки - неизбежный и важный процесс и спланировав его, вы сможете извлечь из него выгоду. Главное правило эволюции ПО - эволюция должна повышать внутреннее качество программы.

**Рефакторинг** - изменение внутренней структуры ПО без изменения его наблюдаемого поведения, призванное облегчить его понимание и удешевить модификацию. Разумные причины выполнения рефактиринга ("запахи" кода):
- код повторяется. Копирование и вставка кода - следствие ошибки проектирования.
- метод слишком велик. Если вам кажется, что после разделения одного метода на несколько код станет яснее, создайте дополнительные методы.
- цикл слишком велик или слишком глубоко вложен в другие циклы;
- класс имеет плохую связность;
- интерфейс класса не формирует согласованную абстракцию;
- метод принимает слишком много параметров;
- отдельные части класса изменяются независимо от других частей;
- при изменении программы требуется параллельно изменять несколько классов;
- вам приходится параллельно изменять несколько иерархий наследования;
- вам приходится параллельно изменять несколько блоков case;
- родственные элементы данных, используемые вместе, не организованы в классы;
- метод использует больше элементов другого класса, чем своего собственного;
- элементарный тип данных перегружен;
- класс имеет слишком ограниченную функциональность. Может удалить класс, распределив его обязанности между другими классами?
- по цепи методов передаются бродячие данные;
- объект-посредник ничего не делает;
- один класс слишком много знает о другом классе;
- метод имеет неудачное имя;
- данные-члены сделаны открытыми;
- подкласс использует только малую долю методов свои предков;
- сложный код объясняется при помощи комментариев;
- код содержит глобальные переменные;
- перед вызовом методы выполняется подготовительный код (после вызова методы выполняется код "уборки");
- программа содержит код, который может когда-нибудь понадобиться.

### Отдельные виды рефакторинга
**Рефакторинг на уровне данных**
- замена магического числа на именованную константу;
- присвоение переменной более сного или информативного имени;
- встраивание выражения в код. Замените промежуточную переменную, которой присваивается результат вычисления выражения, на само выражение;
- замена выражения на вызов метода. Устранение из кода повторяющихся выражений.
- введение промежуточной переменной;
- преобразование многоцелевой переменной в несколько одноцелевых переменных;
- использование локальной переменной вместо параметра;
- преобразование элементарного типа данных в класс;
- преобразование набора кодов в класс или перечисление;
- преобразование набора кодов в класс, имеющий производные классы;
- преобразование массива в класс;
- инкапсуляция набора;
- замена традиционной записи на класс данных.

**Рефакторинг на уровне отдельных операторов**
- декомпозиция логического выражения;
- вынесение сложного логическоо выражения в грамотно названную булеву функцию;
- консолидация фрагментов, повторяющихся в разных частях условного оператора;
- использование оператора break или return вместо управляющей переменной цикла;
- возврат из метода сразу после получения ответа вместо установки возвращаемого значения внутри вложенных операторов if-then-else;
- замена условных операторов (особенно многочисленных блоков case) на вызов полиморфного метода;
- создание и использование "пустых" объектов вместо того, чтобы проверять, равно ли значение null.

**Рефакторинг на уровне отдельных методов**
- извлечение метода из другого метода;
- встраивание кода метода;
- преобразование объемного метода в класс;
- замена сложного алгоритма на простой;
- добавление параметра;
- удаление параметра;
- отделение операций запроса данных от операций изменения данных;
- объединение похожих методов путем их параметризации;
- разделение метода, поведение которого зависит от полученных параметров;
- передача в метод целого объекта вместо отдельных полей;
- передача в метод отдельных полей вместо целого объекта;
- инкапсуляция нисходящего приведения типов.

**Рефакторинг реализации классов**
- Замена объектов-значений на объекты-ссылки.
- Замена объектов-ссылок на объекты-значения.
- Замена виртуальных методов на инициализацию данных.
- Изменение положения методов-членов или данных-членов в иерархии наследования.
- Перемещение специализированного кода в подкласс.
- Объединение похожего кода и его перемещение в суперкласс.

**Рефакторинг интерфейсов классов**
- Перемещение метода в другой класс.
- Разделение одного класса на несколько.
- Удаление класса.
- Сокрытие делегата.
- Удаление посредника.
- Замена наследования на делегирование.
- Замена делегирования на наследование.
- Создание внешнего метода.
- Создание класса-расширения.
- Инкапсуляция открытой переменной-члена.
- Удаление методов установки значений неизменяемых полей.
- Сокрытие методов, которые не следует вызывать извне класса.
- Инкапсуляция неиспользуемых методов.
- Объединение суперкласса и подкласса, имеющих очень похожую реализацию.

**Рефакторинг на уровне системы**
- Создание эталонного источника данных, которые вы не можете контролировать.
- Изменение однонаправленной связи между классами на двунаправленную.
- Изменение двунаправленной связи между классами на однонаправленную.
- Предоставление фабричного метода вместо простого конструктора.
- Замена кодов ошибок на исключения или наоборот.

**Плохие причины выполнения рефакторинга**
- Не рассматривайте рефакторинг как оправдание написания плохого кода с намерением исправить его позднее
- Не рассматривайте рефакторинг как способ, позволяющий избежать переписывания кода

Одной из стратегий улучшения готовой системы является постепенный рефакторинг плохого унаследованного кода — перемещение его на другую сторону «интерфейса между двумя мирами»

### Ключевые моменты
- Изменения программы неизбежны как во время первоначальной разработки, так и после выпуска первой версии.
- Изменения могут приводить как к улучшению, так и к ухудшению ПО. Главное Правило Эволюции ПО заключается в том, что при эволюции кода внутреннее качество программы должно повышаться.
- Одним из условий успешности рефакторинга является пристальное внимание к многочисленным предупреждающим знакам — «запахам», указывающим на необходимость рефакторинга.
- Другое условие — изучение многих конкретных видов рефакторинга.
- Заключительным условием успешности рефакторинга является следование стратегии безопасного рефакторинга. Одни подходы к рефакторингу лучше, а другие хуже.
- Рефакторинг во время разработки — самая благоприятная возможность улучшения программы и внесения в нее всех изменений, которые вам так или иначе захочется внести позднее. Используйте эту возможность!